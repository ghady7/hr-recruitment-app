<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talent Intelligence Platform | AI-Powered Recruitment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        /* ==================== DESIGN TOKENS ==================== */
        :root {
            /* Color Palette - Professional Corporate */
            --color-background: #fafbfc;
            --color-surface: #ffffff;
            --color-surface-elevated: #ffffff;
            --color-border: #e4e7eb;
            --color-border-subtle: #f1f3f5;

            /* Text Hierarchy */
            --color-text-primary: #0f172a;
            --color-text-secondary: #475569;
            --color-text-tertiary: #94a3b8;
            --color-text-inverse: #ffffff;

            /* Brand & Accents */
            --color-primary: #2563eb;
            --color-primary-hover: #1d4ed8;
            --color-primary-light: #dbeafe;
            --color-success: #10b981;
            --color-success-light: #d1fae5;
            --color-warning: #f59e0b;
            --color-warning-light: #fef3c7;
            --color-danger: #ef4444;
            --color-danger-light: #fee2e2;

            /* Shadows - Refined depth system */
            --shadow-xs: 0 1px 2px 0 rgba(15, 23, 42, 0.03);
            --shadow-sm: 0 1px 3px 0 rgba(15, 23, 42, 0.06), 0 1px 2px -1px rgba(15, 23, 42, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(15, 23, 42, 0.08), 0 2px 4px -2px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.08), 0 4px 6px -4px rgba(15, 23, 42, 0.08);
            --shadow-xl: 0 20px 25px -5px rgba(15, 23, 42, 0.08), 0 8px 10px -6px rgba(15, 23, 42, 0.08);

            /* Typography */
            --font-primary: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', monospace;

            /* Spacing Scale */
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==================== BASE STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ==================== LAYOUT ==================== */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--space-xl) var(--space-lg);
        }

        /* ==================== HEADER ==================== */
        .app-header {
            margin-bottom: var(--space-2xl);
            padding-bottom: var(--space-xl);
            border-bottom: 1px solid var(--color-border);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-lg);
        }

        .header-title-section {
            flex: 1;
            min-width: 300px;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: var(--color-text-primary);
            margin-bottom: var(--space-xs);
            line-height: 1.2;
        }

        .header-subtitle {
            font-size: 0.9375rem;
            color: var(--color-text-secondary);
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .header-stats {
            display: flex;
            gap: var(--space-lg);
            align-items: center;
        }

        .stat-pill {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xs);
        }

        .stat-pill-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-primary-light);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .stat-pill-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-pill-label {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-tertiary);
            font-weight: 700;
        }

        .stat-pill-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--color-text-primary);
            font-family: var(--font-mono);
        }

        /* ==================== CARDS ==================== */
        .section-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-lg);
            overflow: hidden;
            transition: box-shadow var(--transition-base);
        }

        .section-card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header-custom {
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--color-border-subtle);
            background: var(--color-surface);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .card-step-badge {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: var(--color-text-inverse);
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 0.875rem;
            font-family: var(--font-mono);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .card-title {
            font-size: 1.0625rem;
            font-weight: 700;
            color: var(--color-text-primary);
            letter-spacing: -0.02em;
            margin: 0;
        }

        .card-body-custom {
            padding: var(--space-xl);
        }

        /* ==================== FORMS ==================== */
        .form-group-custom {
            margin-bottom: var(--space-lg);
        }

        .form-label-custom {
            display: block;
            font-size: 0.8125rem;
            font-weight: 700;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-sm);
            letter-spacing: -0.01em;
            text-transform: uppercase;
            font-size: 0.6875rem;
            letter-spacing: 0.05em;
        }

        .form-control-custom {
            width: 100%;
            padding: 0.875rem var(--space-md);
            font-size: 0.9375rem;
            font-family: var(--font-primary);
            color: var(--color-text-primary);
            background: var(--color-surface);
            border: 1.5px solid var(--color-border);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            outline: none;
        }

        .form-control-custom:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }

        .form-control-custom::placeholder {
            color: var(--color-text-tertiary);
        }

        textarea.form-control-custom {
            resize: vertical;
            min-height: 120px;
            font-family: var(--font-primary);
            line-height: 1.6;
        }

        input[type="file"].form-control-custom {
            padding: 0.75rem var(--space-md);
            cursor: pointer;
        }

        input[type="file"].form-control-custom::file-selector-button {
            padding: 0.5rem var(--space-md);
            margin-right: var(--space-md);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        input[type="file"].form-control-custom::file-selector-button:hover {
            background: var(--color-border-subtle);
        }

        /* ==================== BUTTONS ==================== */
        .btn-custom {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: 0.875rem var(--space-lg);
            font-size: 0.9375rem;
            font-weight: 600;
            font-family: var(--font-primary);
            line-height: 1;
            text-align: center;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            outline: none;
            text-decoration: none;
            letter-spacing: -0.01em;
        }

        .btn-primary-custom {
            background: var(--color-primary);
            color: var(--color-text-inverse);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }

        .btn-primary-custom:hover {
            background: var(--color-primary-hover);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
            transform: translateY(-1px);
        }

        .btn-primary-custom:active {
            transform: translateY(0);
        }

        .btn-secondary-custom {
            background: var(--color-background);
            color: var(--color-text-primary);
            border: 1.5px solid var(--color-border);
        }

        .btn-secondary-custom:hover {
            background: var(--color-surface);
            border-color: var(--color-text-tertiary);
        }

        .btn-success-custom {
            background: var(--color-success);
            color: var(--color-text-inverse);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .btn-success-custom:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
            transform: translateY(-1px);
        }

        .btn-sm-custom {
            padding: 0.5rem var(--space-md);
            font-size: 0.8125rem;
        }

        .btn-block-custom {
            width: 100%;
        }

        .btn-group-custom {
            display: grid;
            gap: var(--space-md);
        }

        /* ==================== TABLES ==================== */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: var(--radius-md);
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--color-background);
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-tertiary);
        }

        .table-custom {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
        }

        .table-custom thead {
            position: sticky;
            top: 0;
            background: var(--color-background);
            z-index: 10;
        }

        .table-custom thead th {
            padding: var(--space-md) var(--space-lg);
            text-align: left;
            font-size: 0.6875rem;
            font-weight: 700;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1.5px solid var(--color-border);
        }

        .table-custom tbody tr {
            border-bottom: 1px solid var(--color-border-subtle);
            transition: background var(--transition-fast);
        }

        .table-custom tbody tr:hover {
            background: var(--color-background);
        }

        .table-custom tbody td {
            padding: var(--space-md) var(--space-lg);
            color: var(--color-text-primary);
            vertical-align: middle;
        }

        .table-custom tbody tr:last-child {
            border-bottom: none;
        }

        /* ==================== BADGES & PILLS ==================== */
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            font-weight: 700;
            font-family: var(--font-mono);
            border-radius: var(--radius-sm);
            min-width: 60px;
        }

        .score-badge.high {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .score-badge.medium {
            background: var(--color-warning-light);
            color: #d97706;
        }

        .score-badge.low {
            background: var(--color-danger-light);
            color: var(--color-danger);
        }

        .rank-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: var(--color-text-inverse);
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 0.9375rem;
            font-family: var(--font-mono);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        /* ==================== EMPTY STATES ==================== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl) var(--space-lg);
            color: var(--color-text-tertiary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xs);
        }

        .empty-state-description {
            font-size: 0.875rem;
            color: var(--color-text-tertiary);
        }

        /* ==================== LOADING STATES ==================== */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--color-text-inverse);
            border-radius: 50%;
            animation: spinner-rotate 0.6s linear infinite;
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        .btn-custom:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) backwards;
        }

        /* ==================== GRID LAYOUTS ==================== */
        .form-row-custom {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        /* ==================== UTILITIES ==================== */
        .text-mono {
            font-family: var(--font-mono);
        }

        .text-semibold {
            font-weight: 600;
        }

        .text-bold {
            font-weight: 700;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .mb-0 {
            margin-bottom: 0;
        }

        .mt-lg {
            margin-top: var(--space-lg);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .app-container {
                padding: var(--space-lg) var(--space-md);
            }

            .header-title {
                font-size: 1.5rem;
            }

            .header-stats {
                flex-wrap: wrap;
            }

            .card-body-custom {
                padding: var(--space-lg);
            }

            .form-row-custom {
                grid-template-columns: 1fr;
            }

            .table-custom {
                font-size: 0.875rem;
            }

            .table-custom thead th,
            .table-custom tbody td {
                padding: var(--space-sm) var(--space-md);
            }
        }

        /* ==================== ACCESSIBILITY ==================== */
        .btn-custom:focus-visible,
        .form-control-custom:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header fade-in-up">
            <div class="header-content">
                <div class="header-title-section">
                    <h1 class="header-title">Talent Intelligence Platform</h1>
                    <p class="header-subtitle">AI-powered candidate analysis and ranking system</p>
                </div>
                <div class="header-stats">
                    <div class="stat-pill">
                        <div class="stat-pill-icon">üìä</div>
                        <div class="stat-pill-content">
                            <span class="stat-pill-label">System Status</span>
                            <span class="stat-pill-value">Active</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="btn-custom btn-secondary-custom" style="height: fit-content;">
                        <span>üö™ Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="row">
            <!-- LEFT COLUMN: Job Creation & Directory -->
            <div class="col-lg-5 col-md-12">

                <!-- CREATE JOB SECTION -->
                <div class="section-card fade-in-up" style="animation-delay: 0.1s;">
                    <div class="card-header-custom">
                        <div class="card-header-left">
                            <div class="card-step-badge">01</div>
                            <h2 class="card-title">Create Job Posting</h2>
                        </div>
                    </div>
                    <div class="card-body-custom">
                        <div class="form-group-custom">
                            <label class="form-label-custom" for="job-title">Job Title</label>
                            <input type="text" id="job-title" class="form-control-custom"
                                placeholder="e.g., Senior Software Engineer" autocomplete="off">
                        </div>

                        <div class="form-group-custom">
                            <label class="form-label-custom" for="job-tag-input">Unique Job Identifier</label>
                            <input type="text" id="job-tag-input" class="form-control-custom"
                                placeholder="e.g., JAVA-2026-01" autocomplete="off">
                        </div>

                        <div class="form-group-custom mb-0">
                            <label class="form-label-custom" for="job-requirements">Job Requirements</label>
                            <textarea id="job-requirements" class="form-control-custom"
                                placeholder="Describe the role requirements, technical skills, experience level, and qualifications..."
                                rows="5"></textarea>
                        </div>

                        <div class="mt-lg">
                            <button onclick="createNewJob()" class="btn-custom btn-primary-custom btn-block-custom">
                                <span>Register Job Posting</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- JOB DIRECTORY SECTION -->
                <div class="section-card fade-in-up" style="animation-delay: 0.2s;">
                    <div class="card-header-custom">
                        <div class="card-header-left">
                            <h2 class="card-title">Job Directory</h2>
                        </div>
                        <button onclick="loadJobs()" class="btn-custom btn-secondary-custom btn-sm-custom">
                            <span>‚Üª Refresh</span>
                        </button>
                    </div>
                    <div class="card-body-custom" style="padding: 0;">
                        <div class="table-container">
                            <table class="table-custom">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">ID</th>
                                        <th>Job Title</th>
                                        <th style="width: 150px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="job-list">
                                    <tr>
                                        <td colspan="3">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">üìã</div>
                                                <div class="empty-state-title">Loading positions...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Upload & Rankings -->
            <div class="col-lg-7 col-md-12">

                <!-- UPLOAD & PROCESS SECTION -->
                <div class="section-card fade-in-up" style="animation-delay: 0.3s;">
                    <div class="card-header-custom">
                        <div class="card-header-left">
                            <div class="card-step-badge">02</div>
                            <h2 class="card-title">Upload & Analyze Candidates</h2>
                        </div>
                    </div>
                    <div class="card-body-custom">
                        <div class="form-row-custom">
                            <div class="form-group-custom mb-0">
                                <label class="form-label-custom" for="job-id-display">Target Job ID</label>
                                <input type="number" id="job-id-display" class="form-control-custom"
                                    placeholder="Select from directory">
                            </div>
                            <div class="form-group-custom mb-0">
                                <label class="form-label-custom" for="resume-files">Resume Files</label>
                                <input type="file" id="resume-files" class="form-control-custom" multiple
                                    accept=".pdf,.doc,.docx">
                            </div>
                        </div>

                        <div class="btn-group-custom mt-lg">
                            <button onclick="uploadFiles()" class="btn-custom btn-success-custom btn-block-custom">
                                <span>Upload Resume Files</span>
                            </button>
                            <button onclick="runBatch()" id="btn-run"
                                class="btn-custom btn-primary-custom btn-block-custom">
                                <span>Run AI Analysis</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- RANKINGS SECTION -->
                <div class="section-card fade-in-up" style="animation-delay: 0.4s;">
                    <div class="card-header-custom">
                        <div class="card-header-left">
                            <h2 class="card-title">Candidate Rankings</h2>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="refreshTable()" class="btn-custom btn-secondary-custom btn-sm-custom">
                                <span>‚Üª Refresh</span>
                            </button>
                            <button onclick="exportToCSV()" class="btn-custom btn-secondary-custom btn-sm-custom">
                                <span>‚¨á Export CSV</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body-custom" style="padding: 0;">
                        <div style="overflow-x: auto;">
                            <table class="table-custom">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Rank</th>
                                        <th>Candidate Name</th>
                                        <th style="width: 120px;">Match Score</th>
                                        <th>Summary</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard">
                                    <tr>
                                        <td colspan="4">
                                            <div class="empty-state">
                                                <div class="empty-state-icon">üë•</div>
                                                <div class="empty-state-title">No candidates analyzed yet</div>
                                                <div class="empty-state-description">Upload resumes and run AI analysis
                                                    to see rankings</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ==================== INITIALIZATION ====================
        if (!checkAuthentication()) {
            throw new Error('Not authenticated');
        }
        window.onload = loadJobs;

        // ==================== AUTHENTICATION CHECK ====================
        function checkAuthentication() {
            const authToken = localStorage.getItem('auth_token');
            const guestToken = localStorage.getItem('guest_session_token');

            // If no auth token AND no guest token, redirect to login
            if (!authToken && !guestToken) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // ==================== HELPER FUNCTIONS ====================
        function isGuest() {
            return localStorage.getItem('is_guest') === 'true';
        }

        function isAuthenticated() {
            return localStorage.getItem('auth_token') !== null;
        }

        // ==================== GUEST JOBS MANAGEMENT ====================
        function getGuestJobs() {
            const jobs = localStorage.getItem('guest_jobs');
            return jobs ? JSON.parse(jobs) : [];
        }

        function saveGuestJobs(jobs) {
            localStorage.setItem('guest_jobs', JSON.stringify(jobs));
        }

        function addGuestJob(title, tag, requirements) {
            const jobs = getGuestJobs();
            const newJob = {
                id: Date.now(), // Use timestamp as unique ID
                title: title,
                tag: tag,
                requirements: requirements,
                created_at: new Date().toISOString()
            };
            jobs.push(newJob);
            saveGuestJobs(jobs);
            return newJob.id;
        }

        function deleteGuestJob(jobId) {
            let jobs = getGuestJobs();
            jobs = jobs.filter(job => job.id !== jobId);
            saveGuestJobs(jobs);
            // Also delete associated resumes
            deleteGuestResumesForJob(jobId);
        }

        // ==================== GUEST RESUMES MANAGEMENT ====================
        function getGuestResumes(jobId) {
            const resumes = localStorage.getItem(`guest_resumes_${jobId}`);
            return resumes ? JSON.parse(resumes) : [];
        }

        function saveGuestResumes(jobId, resumes) {
            localStorage.setItem(`guest_resumes_${jobId}`, JSON.stringify(resumes));
        }

        function addGuestResume(jobId, filename, content, candidateName) {
            const resumes = getGuestResumes(jobId);
            const newResume = {
                id: Date.now(),
                filename: filename,
                content: content,
                candidate_name: candidateName || filename,
                match_score: 0,
                ai_analysis: ''
            };
            resumes.push(newResume);
            saveGuestResumes(jobId, resumes);
            return newResume.id;
        }

        function deleteGuestResumesForJob(jobId) {
            localStorage.removeItem(`guest_resumes_${jobId}`);
        }

        // ==================== LOGOUT ====================
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Check if user is guest
                const isGuestUser = localStorage.getItem('is_guest') === 'true';

                if (isGuestUser) {
                    // For guest users: keep all guest data (jobs, resumes, etc.)
                    localStorage.removeItem('guest_session_token');
                    // is_guest, guest_jobs, and all guest_resumes_* persist so they load next time
                } else {
                    // For authenticated users: clear everything
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('email');
                    localStorage.removeItem('guest_session_token');
                    localStorage.removeItem('is_guest');
                    localStorage.removeItem('guest_jobs');

                    // Also remove any guest resume data
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('guest_resumes_')) {
                            localStorage.removeItem(key);
                        }
                    });
                }

                // Redirect to login
                window.location.href = '/login';
            }
        }

        // ==================== LOAD JOBS ====================
        async function loadJobs() {
            try {
                const jobList = document.getElementById('job-list');
                let jobs = [];

                // If guest, load from localStorage
                if (isGuest()) {
                    jobs = getGuestJobs();
                    displayJobList(jobs);
                } else if (isAuthenticated()) {
                    // If authenticated, load from server
                    const response = await fetch('/jobs/', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    });
                    const data = await response.json();
                    displayJobList(data.jobs || []);
                }
            } catch (err) {
                console.error("Error loading jobs:", err);
                document.getElementById('job-list').innerHTML = `
                    <tr>
                        <td colspan="3">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ö†Ô∏è</div>
                                <div class="empty-state-title">Error loading positions</div>
                                <div class="empty-state-description">Please try again</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function displayJobList(jobs) {
            const jobList = document.getElementById('job-list');
            jobList.innerHTML = "";

            if (jobs && jobs.length > 0) {
                jobs.forEach((job, index) => {
                    const row = document.createElement('tr');
                    row.className = 'fade-in-up';
                    row.style.animationDelay = `${index * 0.05}s`;
                    const jobId = job.id || job.job_id;
                    row.innerHTML = `
                        <td><span class="text-mono text-bold" style="color: var(--color-primary);">${jobId}</span></td>
                        <td>${escapeHtml(job.title || job.job_title)}</td>
                        <td style="display: flex; gap: 8px;">
                            <button class="btn-custom btn-secondary-custom btn-sm-custom" 
                                    onclick="selectJob(${jobId})">
                                Select
                            </button>
                            <button class="btn-custom btn-sm-custom" 
                                    onclick="deleteJob(${jobId})"
                                    style="background-color: var(--color-danger); color: white; border: none;">
                                Delete
                            </button>
                        </td>
                    `;
                    jobList.appendChild(row);
                });
            } else {
                jobList.innerHTML = `
                    <tr>
                        <td colspan="3">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <div class="empty-state-title">No job postings yet</div>
                                <div class="empty-state-description">Create your first position above</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // ==================== SELECT JOB ====================
        function selectJob(id) {
            document.getElementById('job-id-display').value = id;
            refreshTable();
        }

        // ==================== DELETE JOB ====================
        async function deleteJob(jobId) {
            if (!confirm(`Are you sure you want to delete Job ID ${jobId}? This will also delete all associated resumes.`)) {
                return;
            }

            try {
                // If guest, delete from localStorage
                if (isGuest()) {
                    deleteGuestJob(jobId);
                    alert(`‚úì Job deleted`);
                    loadJobs();
                    // Clear job display if it was the selected job
                    const currentJobId = parseInt(document.getElementById('job-id-display').value);
                    if (currentJobId === jobId) {
                        document.getElementById('job-id-display').value = '';
                        refreshTable();
                    }
                } else {
                    // If authenticated, delete from server
                    const response = await fetch(`/delete-job/?job_id=${jobId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    });

                    const result = await response.json();

                    if (result.message) {
                        alert(`‚úì ${result.message}`);
                        loadJobs();
                        // Clear job display if it was the selected job
                        const currentJobId = parseInt(document.getElementById('job-id-display').value);
                        if (currentJobId === jobId) {
                            document.getElementById('job-id-display').value = '';
                            refreshTable();
                        }
                    } else if (result.error) {
                        alert(`‚ùå ${result.error}`);
                    }
                }
            } catch (err) {
                console.error("Error deleting job:", err);
                alert("‚ùå Error deleting job. Please try again.");
            }
        }

        // ==================== CREATE JOB ====================
        async function createNewJob() {
            const title = document.getElementById('job-title').value.trim();
            const tag = document.getElementById('job-tag-input').value.trim();
            const reqs = document.getElementById('job-requirements').value.trim();

            if (!title || !tag || !reqs) {
                alert("‚ö†Ô∏è All fields are required");
                return;
            }

            try {
                // If guest, save to localStorage
                if (isGuest()) {
                    // Check for duplicate tags in guest jobs
                    const existingJobs = getGuestJobs();
                    if (existingJobs.some(job => job.tag === tag)) {
                        alert("‚úó Job tag already exists. Please use a unique ID.");
                        return;
                    }

                    const jobId = addGuestJob(title, tag, reqs);
                    alert(`‚úì Job registered successfully (ID: ${jobId})`);
                    document.getElementById('job-id-display').value = jobId;
                    document.getElementById('job-title').value = '';
                    document.getElementById('job-tag-input').value = '';
                    document.getElementById('job-requirements').value = '';
                    loadJobs();
                } else {
                    // If authenticated, send to server
                    const response = await fetch(`/create-job/?title=${encodeURIComponent(title)}&tag=${encodeURIComponent(tag)}&requirements=${encodeURIComponent(reqs)}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    });

                    const result = await response.json();

                    if (result.job_id) {
                        alert(`‚úì Job registered successfully (ID: ${result.job_id})`);
                        document.getElementById('job-id-display').value = result.job_id;
                        document.getElementById('job-title').value = '';
                        document.getElementById('job-tag-input').value = '';
                        document.getElementById('job-requirements').value = '';
                        loadJobs();
                    } else {
                        alert("‚úó Error: " + (result.error || "Registration failed. The job tag may already exist."));
                    }
                }
            } catch (err) {
                console.error("Error creating job:", err);
                alert("‚úó An error occurred while creating the job");
            }
        }

        // ==================== UPLOAD FILES ====================
        async function uploadFiles() {
            const jobId = document.getElementById('job-id-display').value;
            const files = document.getElementById('resume-files').files;

            if (!jobId || files.length === 0) {
                alert("‚ö†Ô∏è Please select a Job ID and choose files to upload");
                return;
            }

            try {
                // If guest, save to localStorage
                if (isGuest()) {
                    let addedCount = 0;
                    let skippedCount = 0;

                    for (const file of files) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const content = e.target.result;
                            const candidateName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
                            addGuestResume(jobId, file.name, content, candidateName);
                            addedCount++;
                        };
                        reader.readAsText(file);
                    }

                    setTimeout(() => {
                        alert(`‚úÖ Done!\nAdded: ${files.length} resumes to local storage`);
                        document.getElementById('resume-files').value = "";
                    }, 500);
                } else {
                    // If authenticated, send to server
                    const formData = new FormData();
                    for (const file of files) {
                        formData.append("files", file);
                    }

                    const response = await fetch(`/upload/?job_id=${jobId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        },
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(`‚úÖ Done!\nAdded: ${result.added} new resumes\nSkipped: ${result.skipped} duplicates`);
                        document.getElementById('resume-files').value = "";
                    } else {
                        alert("‚úó Upload failed. " + (result.error || "Please try again."));
                    }
                }
            } catch (err) {
                console.error("Error uploading files:", err);
                alert("‚úó An error occurred during upload");
            }
        }

        // ==================== RUN AI ANALYSIS ====================
        async function runBatch() {
            const jobId = document.getElementById('job-id-display').value;
            const btn = document.getElementById('btn-run');

            if (!jobId) {
                alert("‚ö†Ô∏è Please select a Job ID");
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span><span>Processing...</span>';

                // If guest, analyze locally
                if (isGuest()) {
                    const resumes = getGuestResumes(jobId);
                    if (resumes.length === 0) {
                        alert("‚ö†Ô∏è No resumes to analyze");
                        return;
                    }

                    // Strict job requirement validation - must be a valid, real job description
                    const job = getGuestJobs().find(j => j.id == jobId);
                    const jobReqs = job.requirements.toLowerCase().trim();

                    // Comprehensive validation function
                    function isValidJobRequirement(reqText) {
                        // 1. Minimum length (must be at least 8 characters)
                        if (reqText.length < 8) return false;

                        // 2. Split into words and filter
                        const words = reqText.split(/\W+/).filter(w => w.length > 0);
                        if (words.length < 3) return false; // Need at least 3 words

                        // 3. Check for gibberish patterns
                        let validWords = 0;
                        let totalVowels = 0;

                        words.forEach(word => {
                            if (word.length >= 2) {
                                // Count vowels in word
                                const vowels = (word.match(/[aeiou]/g) || []).length;
                                const vowelRatio = vowels / word.length;

                                // Valid word needs at least 25% vowels
                                if (vowelRatio >= 0.25 && word.length <= 20) {
                                    validWords++;
                                    totalVowels += vowels;
                                }
                            }
                        });

                        // 4. Need minimum 3 valid words
                        if (validWords < 3) return false;

                        // 5. Overall vowel ratio must be good (30%+)
                        const overallVowelRatio = totalVowels / reqText.replace(/\W/g, '').length;
                        if (overallVowelRatio < 0.30) return false;

                        // 6. No gibberish pattern: 4+ repeated characters
                        if (/(.)\1{3,}/.test(reqText)) return false;

                        // 7. Must not be mostly numbers
                        const numberRatio = (reqText.match(/\d/g) || []).length / reqText.length;
                        if (numberRatio > 0.5) return false;

                        return true;
                    }

                    // Validate job requirement strictly
                    const isValidJob = isValidJobRequirement(jobReqs);

                    resumes.forEach(resume => {
                        if (!isValidJob) {
                            // INVALID JOB - Return 0% for ALL resumes
                            resume.match_score = 0;
                            resume.ai_analysis = "‚ùå Invalid job requirement - cannot analyze";
                        } else {
                            // VALID JOB - Perform keyword matching
                            const resumeText = resume.content.toLowerCase();
                            const validKeywords = jobReqs.split(/\W+/).filter(w => w.length >= 3);
                            let matches = 0;
                            let matchedList = [];

                            validKeywords.forEach(keyword => {
                                if (resumeText.includes(keyword)) {
                                    matches++;
                                    matchedList.push(keyword);
                                }
                            });

                            resume.match_score = validKeywords.length > 0 ? Math.round((matches / validKeywords.length) * 100) : 0;
                            resume.ai_analysis = matches > 0 ?
                                `‚úì Matched ${matches}/${validKeywords.length} keywords: ${matchedList.slice(0, 3).join(', ')}` :
                                '‚úó No matching keywords';
                        }
                    });

                    saveGuestResumes(jobId, resumes);
                    alert(isValidJob ? "‚úì Analysis complete!" : "‚ö†Ô∏è Invalid job requirement - all scores set to 0%");
                    refreshTable();
                } else {
                    // If authenticated, send to server
                    const response = await fetch(`/analyze-batch/?job_id=${jobId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    });
                    const result = await response.json();
                    alert("‚úì Server analysis complete!");
                    refreshTable();
                }
            } catch (err) {
                console.error("Error running analysis:", err);
                alert("‚úó Analysis failed. Please try again.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>Run AI Analysis</span>';
            }
        }

        // ==================== REFRESH RANKINGS TABLE ====================
        async function refreshTable() {
            const jobId = document.getElementById('job-id-display').value;
            if (!jobId) return;

            try {
                const table = document.getElementById('leaderboard');
                let rankings = [];

                // If guest, get from localStorage
                if (isGuest()) {
                    rankings = getGuestResumes(jobId);
                    // Sort by score
                    rankings.sort((a, b) => b.match_score - a.match_score);
                    displayRankings(rankings);
                } else {
                    // If authenticated, get from server
                    const response = await fetch(`/rankings/?job_id=${jobId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    });
                    const data = await response.json();
                    displayRankings(data.rankings || []);
                }
            } catch (err) {
                console.error("Error refreshing rankings:", err);
                document.getElementById('leaderboard').innerHTML = `
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ö†Ô∏è</div>
                                <div class="empty-state-title">Error loading rankings</div>
                                <div class="empty-state-description">Please try again</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function displayRankings(rankings) {
            const table = document.getElementById('leaderboard');
            table.innerHTML = "";

            if (rankings && rankings.length > 0) {
                rankings.forEach((candidate, index) => {
                    // Normalize field names (server uses 'score'/'summary', guests use 'match_score'/'ai_analysis')
                    const score = candidate.match_score !== undefined ? candidate.match_score : candidate.score;
                    const analysis = candidate.ai_analysis !== undefined ? candidate.ai_analysis : candidate.summary;

                    const scoreClass = score > 70 ? 'high' :
                        (score > 40 ? 'medium' : 'low');

                    const row = document.createElement('tr');
                    row.className = 'fade-in-up';
                    row.style.animationDelay = `${index * 0.05}s`;
                    row.innerHTML = `
                        <td>
                            <div class="rank-indicator">${index + 1}</div>
                        </td>
                        <td><span class="text-semibold">${escapeHtml(candidate.candidate_name)}</span></td>
                        <td>
                            <span class="score-badge ${scoreClass}">${score}%</span>
                        </td>
                        <td>
                            <span class="text-sm" style="color: var(--color-text-secondary);">
                                ${escapeHtml(analysis || 'Analysis pending')}
                            </span>
                        </td>
                    `;
                    table.appendChild(row);
                });
            } else {
                table.innerHTML = `
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <div class="empty-state-title">No rankings available</div>
                                <div class="empty-state-description">Upload and analyze resumes for this position</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // ==================== UTILITY FUNCTION ====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== EXPORT TO CSV ====================
        async function exportToCSV() {
            const jobId = document.getElementById('job-id-display').value;

            if (!jobId) {
                alert("‚ö†Ô∏è Please select a Job ID");
                return;
            }

            try {
                // If guest, export from localStorage
                if (isGuest()) {
                    const resumes = getGuestResumes(jobId);
                    const job = getGuestJobs().find(j => j.id == jobId);

                    if (resumes.length === 0) {
                        alert("‚ö†Ô∏è No resumes to export");
                        return;
                    }

                    // Generate CSV
                    let csv = "Rank,Candidate Name,Match Score,Analysis\n";
                    resumes.sort((a, b) => {
                        const scoreA = a.match_score !== undefined ? a.match_score : a.score;
                        const scoreB = b.match_score !== undefined ? b.match_score : b.score;
                        return scoreB - scoreA;
                    }).forEach((resume, idx) => {
                        const score = resume.match_score !== undefined ? resume.match_score : resume.score;
                        const analysis = resume.ai_analysis !== undefined ? resume.ai_analysis : resume.summary;
                        csv += `${idx + 1},"${resume.candidate_name}",${score},"${analysis}"\n`;
                    });

                    // Download CSV
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `candidates_${jobId}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    alert("‚úì CSV exported successfully!");
                } else {
                    // If authenticated, get from server
                    const response = await fetch(`/export-csv/?job_id=${jobId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    });
                    if (!response.ok) {
                        throw new Error("Export failed");
                    }

                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = 'candidates_export.csv';
                    if (contentDisposition) {
                        const matches = contentDisposition.match(/filename=([^;]+)/);
                        if (matches) {
                            filename = matches[1].replace(/"/g, '');
                        }
                    }

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    alert("‚úì CSV exported successfully!");
                }
            } catch (err) {
                console.error("Error exporting CSV:", err);
                alert("‚úó Export failed. Please try again.");
            }
        }
    </script>
</body>

</html>